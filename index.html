<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meridional Raytracer (2D) — TVL Lens Builder</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<header class="topbar">
  <div class="brand">
    <div class="dot"></div>
    <div class="brandText">
      <div class="title">Meridional Raytracer (2D)</div>
      <div class="subtitle">OSLO-ish doorsnede • stop-aware • element builder • sanity check tool</div>
    </div>
  </div>

  <div class="toolbar">
    <button id="btnNew" class="btn">New / Clear</button>
    <button id="btnLoadOmit" class="btn">Load OMIT 50 preset</button>
    <button id="btnLoadDemo" class="btn">Load demo lens</button>

    <div class="sep"></div>

    <button id="btnAdd" class="btn">+ Surface</button>
    <button id="btnAddElement" class="btn">+ Element</button>
    <button id="btnDuplicate" class="btn">Duplicate</button>
    <button id="btnMoveUp" class="btn">↑</button>
    <button id="btnMoveDown" class="btn">↓</button>
    <button id="btnRemove" class="btn btnDanger">Delete</button>

    <div class="sep"></div>

    <button id="btnScaleToFocal" class="btn">Scale → FL</button>
    <button id="btnSetTStop" class="btn">Set T</button>
    <button id="btnAutoFocus" class="btn">Auto focus</button>

    <div class="sep"></div>

    <button id="btnSave" class="btn">Save JSON</button>
    <label class="fileBtn btn">
      Load JSON
      <input id="fileLoad" type="file" accept="application/json" />
    </label>
  </div>
</header>

<main class="layout">
  <!-- LEFT -->
  <aside class="panel left">
    <section class="panelHeader">
      <div class="h1">Surface Data</div>
      <div class="hint">
        Klik een rij om te selecteren. R=0 is plane. Glass = medium ná surface. Stop = 1 surface. IMS ap = sensor half-height.
      </div>
    </section>

    <section class="controls">
      <div class="controlGrid">
        <div class="ctrl">
          <label>Sensor preset</label>
          <select id="sensorPreset"></select>
        </div>

        <div class="ctrl two">
          <label>Sensor W (mm)</label>
          <input id="sensorW" type="number" step="0.01" />
        </div>
        <div class="ctrl two">
          <label>Sensor H (mm)</label>
          <input id="sensorH" type="number" step="0.01" />
        </div>

        <div class="ctrl">
          <label>Field angle (deg)</label>
          <input id="fieldAngle" type="number" step="0.1" value="0" />
        </div>

        <div class="ctrl">
          <label># Rays</label>
          <input id="rayCount" type="number" step="1" value="31" min="3" max="101" />
        </div>

        <div class="ctrl">
          <label>Wavelength</label>
          <select id="wavePreset">
            <option value="d">d-line (587.6nm) — simple</option>
            <option value="g">g-line (blue) — approx</option>
            <option value="c">c-line (red) — approx</option>
          </select>
        </div>

        <div class="ctrl">
          <label>Sensor offset (mm)</label>
          <input id="sensorOffset" type="number" step="0.05" value="0" />
        </div>

        <div class="ctrl">
          <label>Render scale</label>
          <input id="renderScale" type="range" min="0.6" max="2.6" step="0.05" value="1.25" />
        </div>

        <!-- PREVIEW CONTROLS -->
        <div class="ctrl two">
          <label>Preview image</label>
          <input id="prevImg" type="file" accept="image/*" />
        </div>

        <div class="ctrl">
          <label>Object distance (mm)</label>
          <input id="prevObjDist" type="number" step="1" value="2000" />
        </div>

        <div class="ctrl">
          <label>Object height (mm)</label>
          <input id="prevObjH" type="number" step="1" value="500" />
        </div>

        <div class="ctrl">
          <label>Preview res</label>
          <select id="prevRes">
            <option value="256">256 px (fast)</option>
            <option value="384" selected>384 px</option>
            <option value="512">512 px</option>
            <option value="768">768 px (slow)</option>
          </select>
        </div>

        <div class="ctrl two">
          <label>&nbsp;</label>
          <button id="btnRenderPreview" class="btn btnPrimary" type="button">Render Preview</button>
        </div>
      </div>
    </section>

    <section class="tableWrap">
      <table class="tbl">
        <thead>
          <tr>
            <th style="width:42px">#</th>
            <th style="width:86px">Type</th>
            <th style="width:110px">Radius R</th>
            <th style="width:110px">Thickness</th>
            <th style="width:110px">Aperture</th>
            <th style="width:170px">Glass</th>
            <th style="width:70px">Stop?</th>
          </tr>
        </thead>
        <tbody id="surfTbody"></tbody>
      </table>
    </section>

    <section class="status">
      <div id="statusText" class="statusLine">—</div>
      <div class="badges">
        <div id="badgeEfl" class="badge">EFL: —</div>
        <div id="badgeBfl" class="badge">BFL: —</div>
        <div id="badgeT" class="badge">T≈ —</div>
        <div id="badgeVig" class="badge">Vignette: —</div>
      </div>
      <div class="badges">
        <div id="badgeFov" class="badge badgeWide">FOV: —</div>
        <div id="badgeCov" class="badge">COV: —</div>
      </div>

      <div class="footerRow">
        <div id="metaInfo" class="meta">sensor —</div>
        <div id="footerWarn" class="warn"></div>
      </div>
    </section>
  </aside>

  <!-- RIGHT -->
  <section class="panel right">
    <div class="canvasHeader">
      <div class="canvasTitle">
        <div class="h1">Autodraw</div>
        <div class="hint">drag = pan • wheel = zoom • dblclick = reset view</div>
      </div>

      <div class="topBadges">
        <div id="badgeEflTop" class="pill">EFL: —</div>
        <div id="badgeBflTop" class="pill">BFL: —</div>
        <div id="badgeTTop" class="pill">T≈ —</div>
        <div id="badgeFovTop" class="pill">FOV: —</div>
        <div id="badgeCovTop" class="pill">COV: —</div>
      </div>
    </div>

    <div class="canvasFrame">
      <div class="canvasSplit" id="tvlCanvasSplit">
        <!-- LEFT: Rays -->
        <div class="pane">
          <div class="paneTag">Rays</div>
          <canvas id="canvas"></canvas>
        </div>

        <!-- RIGHT: Preview -->
        <div class="pane" id="previewPane">
          <div class="paneTag">Preview</div>
          <button id="btnPreviewFS" class="fsBtn" type="button">Full Screen (P)</button>
          <canvas id="previewCanvas"></canvas>
        </div>
      </div>

      <div class="canvasOverlay">
        <div class="overlayHelp" id="overlayHelp">
          Tips: zet stop op “STOP” surface • IMS ap = sensor half-height • “Scale → FL” fixeert focal drift
        </div>
      </div>
    </div>
  </section>
</main>

<!-- MODALS blijven hetzelfde -->
<div id="newLensModal" class="modal hidden">
  <div class="modalCard">
    <div class="modalTop">
      <div>
        <div class="modalTitle">New Lens</div>
        <div class="modalSub">Kies template → target focal → target T → generate.</div>
      </div>
      <button id="nlClose" class="modalX" aria-label="Close">✕</button>
    </div>

    <div class="modalScroll">
      <div class="modalGrid">
        <div class="field">
          <label>Template</label>
          <select id="nlTemplate" class="cellSelect">
            <option value="blank">Blank (OBJ + IMS)</option>
            <option value="doubleGauss">Double-Gauss (baseline)</option>
            <option value="omit50v1">OMIT 50 concept v1</option>
            <option value="tessar">Tessar-ish (simple)</option>
          </select>
        </div>

        <div class="field">
          <label>Target focal (mm)</label>
          <input id="nlFocal" class="cellInput" type="number" step="0.1" value="50" />
        </div>

        <div class="field">
          <label>Target T-stop (approx)</label>
          <input id="nlT" class="cellInput" type="number" step="0.01" value="2.67" />
        </div>

        <div class="field">
          <label>Stop position</label>
          <select id="nlStopPos" class="cellSelect">
            <option value="keep">Keep template</option>
            <option value="middle">Force middle STOP</option>
          </select>
        </div>

        <div class="field fieldFull">
          <label>Notes / Name</label>
          <input id="nlName" class="cellInput" type="text" value="New lens" />
        </div>

        <div class="field fieldFull">
          <div class="glassNote">
            Dit is nog steeds een 2D meridional sanity tool (geen optimizer).
            Maar focal/T kun je hiermee wél strak “terugtrekken”.
          </div>
        </div>
      </div>
    </div>

    <div class="modalBottom">
<button id="nlCreate" class="btn btnPrimary">Create</button>
    </div>
  </div>
</div>

<div id="elementModal" class="modal hidden">
  <div class="modalCard">
    <div class="modalTop">
      <div>
        <div class="modalTitle">Add Element</div>
        <div class="modalSub">Auto (singlet/achromat) of Custom surfaces. Stop = aparte insert.</div>
      </div>
      <button id="elClose" class="modalX" aria-label="Close">✕</button>
    </div>

    <div class="modalScroll">
      <div class="modalGrid">
        <div class="field">
          <label>Type</label>
          <select id="elType" class="cellSelect">
            <option value="achromat">Achromat (4 surfaces)</option>
            <option value="singlet">Singlet (2 surfaces)</option>
            <option value="stop">STOP (1 surface)</option>
            <option value="airgap">Air gap (1 surface)</option>
          </select>
        </div>

        <div class="field">
          <label>Mode</label>
          <select id="elMode" class="cellSelect">
            <option value="auto">Auto</option>
            <option value="custom">Custom</option>
          </select>
        </div>

        <div class="field">
          <label>Element f (mm)</label>
          <input id="elF" class="cellInput" type="number" step="0.1" value="50" />
        </div>

        <div class="field">
          <label>Clear ap (semi-diam, mm)</label>
          <input id="elAp" class="cellInput" type="number" step="0.1" value="18" />
        </div>

        <div class="field">
          <label>Center thickness (mm)</label>
          <input id="elCt" class="cellInput" type="number" step="0.01" value="4" />
        </div>

        <div class="field">
          <label>Internal gap (mm)</label>
          <input id="elGap" class="cellInput" type="number" step="0.01" value="0" />
        </div>

        <div class="field">
          <label>Rear air to next (mm)</label>
          <input id="elAir" class="cellInput" type="number" step="0.01" value="4" />
        </div>

        <div class="field">
          <label>Form</label>
          <select id="elForm" class="cellSelect">
            <option value="symmetric">Symmetric</option>
            <option value="weakMeniscus">Weak meniscus</option>
            <option value="plano">Plano-convex</option>
          </select>
        </div>

        <div class="field">
          <label>Glass 1</label>
          <select id="elGlass1" class="cellSelect"></select>
        </div>

        <div class="field">
          <label>Glass 2</label>
          <select id="elGlass2" class="cellSelect"></select>
        </div>

        <div class="field fieldFull">
          <label>Glass note</label>
          <textarea id="elGlassNote" class="glassNote" readonly></textarea>
        </div>
      </div>

      <div id="customBox" class="customBox hidden">
        <div class="modalGrid" style="margin-top:14px;">
          <div class="field">
            <label># Custom surfaces</label>
            <select id="elCustomCount" class="cellSelect">
              <option value="2">2</option>
              <option value="4" selected>4</option>
              <option value="6">6</option>
              <option value="8">8</option>
            </select>
          </div>
          <div class="field">
            <label>Custom preset</label>
            <select id="elCustomPreset" class="cellSelect">
              <option value="blank">Blank</option>
              <option value="starter">Starter</option>
            </select>
          </div>

          <div class="field fieldFull">
            <table class="customTable">
              <thead>
                <tr>
                  <th style="width:42px">#</th>
                  <th style="width:90px">Type</th>
                  <th style="width:120px">Radius</th>
                  <th style="width:120px">Thick</th>
                  <th style="width:120px">Ap</th>
                  <th style="width:220px">Glass</th>
                </tr>
              </thead>
              <tbody id="elCustomTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="modalBottom">
<button id="elAdd" class="btn btnPrimary">Insert</button>
    </div>
  </div>
</div>

<script src="./script.js"></script>
</body>
</html>
