<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meridional Raytracer (2D) — TVL Lens Builder</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <a class="skipLink" href="#main">Skip to content</a>

  <header class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div class="brandText">
        <div class="title">Meridional Raytracer (2D)</div>
        <div class="subtitle">OSLO-ish doorsnede • stop-aware • element builder • preview LUT • PL reference</div>
      </div>
    </div>

    <div class="toolbar">
      <button id="btnNew" class="btn">New / Clear</button>
      <button id="btnLoadOmit" class="btn">Load OMIT preset</button>
      <button id="btnLoadDemo" class="btn">Load demo</button>

      <div class="sep"></div>

      <button id="btnAdd" class="btn">+ Surface</button>
      <button id="btnAddElement" class="btn btnPrimary">+ Element</button>

      <div class="sep"></div>

      <button id="btnDuplicate" class="btn">Duplicate</button>
      <button id="btnMoveUp" class="btn">↑</button>
      <button id="btnMoveDown" class="btn">↓</button>
      <button id="btnRemove" class="btn btnDanger">Remove</button>

      <div class="sep"></div>

      <button id="btnScaleToFocal" class="btn">Scale → FL</button>
      <button id="btnSetTStop" class="btn">Set T</button>
      <button id="btnAutoFocus" class="btn">Auto focus</button>

      <div class="sep"></div>

      <button id="btnSave" class="btn">Save JSON</button>

      <label class="fileBtn" title="Load lens JSON">
        Load JSON
        <input id="fileLoad" type="file" accept=".json,application/json">
      </label>

      <div class="sep"></div>

      <button id="btnRenderPreview" class="btn btnPrimary">Render Preview</button>
      <button id="btnCancelPreview" class="btn">Cancel render</button>

      <label class="fileBtn" title="Load preview chart image">
        Load chart
        <input id="prevImg" type="file" accept="image/*">
      </label>
    </div>
  </header>

  <main id="main" class="layout">
    <!-- LEFT -->
    <section class="panel left">
      <div class="panelHeader">
        <h1 class="h1">Lens data</h1>
        <div class="hint">Klik op een rij om te selecteren. OBJ/IMS zijn beschermd. STOP slechts één keer mogelijk.</div>
      </div>

      <div class="leftScroll">
        <div class="controls">
          <div class="controlGrid">
            <div class="ctrl">
              <label>Sensor preset</label>
              <select id="sensorPreset"></select>
            </div>

            <div class="ctrl">
              <label>Wave preset</label>
              <select id="wavePreset">
                <option value="c">c (red-ish)</option>
                <option value="d" selected>d (yellow)</option>
                <option value="g">g (blue-ish)</option>
              </select>
            </div>

            <div class="ctrl">
              <label>Sensor W (mm)</label>
              <input id="sensorW" type="number" step="0.01" value="36.70">
            </div>

            <div class="ctrl">
              <label>Sensor H (mm)</label>
              <input id="sensorH" type="number" step="0.01" value="25.54">
            </div>

            <div class="ctrl">
              <label>Field angle (deg)</label>
              <input id="fieldAngle" type="number" step="0.01" value="0">
            </div>

            <div class="ctrl">
              <label>Ray count</label>
              <input id="rayCount" type="number" step="1" value="31" min="3" max="101">
            </div>

            <div class="ctrl">
              <label>Focus mode</label>
              <select id="focusMode">
                <option value="cam" selected>Camera focus (sensorOffset)</option>
                <option value="lens">Lens focus (lensFocus)</option>
              </select>
            </div>

            <div class="ctrl">
              <label>Sensor offset (mm)</label>
              <input id="sensorOffset" type="number" step="0.01" value="0">
            </div>

            <div class="ctrl">
              <label>Lens focus shift (mm)</label>
              <input id="lensFocus" type="number" step="0.01" value="0">
            </div>

            <div class="ctrl">
              <label>Render scale</label>
              <input id="renderScale" type="number" step="0.05" value="1.25">
            </div>

            <div class="ctrl two">
              <label>Preview object distance (mm)</label>
              <input id="prevObjDist" type="number" step="1" value="2000">
            </div>

            <div class="ctrl">
              <label>Preview object height (mm)</label>
              <input id="prevObjH" type="number" step="1" value="1650">
            </div>

            <div class="ctrl">
              <label>Preview base height (px)</label>
              <input id="prevRes" type="number" step="1" value="720">
            </div>

            <div class="ctrl">
              <label><input id="prevDofOn" type="checkbox"> DOF (placeholder)</label>
              <input id="prevSamples" type="number" step="1" value="64" min="1" max="512">
            </div>

            <div class="ctrl">
              <label><input id="prevCaOn" type="checkbox"> Chromatic (placeholder)</label>
              <label><input id="prevProgressive" type="checkbox" checked> Progressive render</label>
            </div>
          </div>
        </div>

        <div class="tableWrap">
          <table class="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Type</th>
                <th>R</th>
                <th>t</th>
                <th>ap</th>
                <th>glass</th>
                <th>STOP</th>
              </tr>
            </thead>
            <tbody id="surfTbody"></tbody>
          </table>
        </div>
      </div>

      <footer class="status">
        <div id="statusText" class="statusLine">—</div>

        <div class="badges">
          <div id="badgeEfl" class="badge badgeWide">Focal Length: —</div>
          <div id="badgeBfl" class="badge badgeWide">BFL: —</div>
          <div id="badgeT" class="badge badgeWide">T≈ —</div>
          <div id="badgeVig" class="badge">Vignette: —</div>
          <div id="badgeFov" class="badge badgeWide">FOV: —</div>
          <div id="badgeCov" class="badge">COV: —</div>
        </div>

        <div class="footerRow">
          <div id="metaInfo" class="meta">—</div>
          <div id="footerWarn" class="warn"></div>
        </div>
      </footer>
    </section>

    <!-- RIGHT -->
    <section class="panel right">
      <div class="canvasHeader">
        <div class="canvasTitle">
          <h1 class="h1">Rays + Preview</h1>
          <div class="hint">Links: doorsnede + rays (pan/zoom met muis). Rechts: preview (pan/zoom). Double-click reset.</div>
        </div>
        <div class="topBadges">
          <div id="badgeEflTop" class="pill">EFL: —</div>
          <div id="badgeBflTop" class="pill">BFL: —</div>
          <div id="badgeTTop" class="pill">T≈ —</div>
          <div id="badgeFovTop" class="pill">FOV: —</div>
          <div id="badgeCovTop" class="pill">COV: —</div>
        </div>
      </div>

      <div class="canvasFrame">
        <div class="canvasSplit">
          <div id="raysPane" class="pane">
            <div class="paneTag">Rays / Lens cutaway</div>
            <button id="btnRaysFS" class="fsBtn">Fullscreen</button>
            <canvas id="canvas"></canvas>
            <div class="canvasOverlay">
              <span class="overlayHelp">Drag: pan • Wheel: zoom • Double-click: reset</span>
            </div>
          </div>

          <div id="previewPane" class="pane">
            <div class="paneTag">Preview</div>
            <button id="btnPreviewFS" class="fsBtn">Fullscreen</button>
            <canvas id="previewCanvas"></canvas>
            <div class="canvasOverlay">
              <span class="overlayHelp">Preview uses axisymmetric reverse-trace LUT (fast). Render Preview after edits.</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ELEMENT MODAL -->
  <div id="elementModal" class="modal hidden" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTop">
        <div>
          <div class="modalTitle">Add Element</div>
          <div class="modalSub">Auto-build singlet / achromat. Optional front air injection.</div>
        </div>
        <button id="elClose" class="modalX">Close</button>
      </div>

      <div class="modalScroll">
        <div class="modalGrid">
          <div class="field">
            <label>Element type</label>
            <select id="elType" class="cellSelect">
              <option value="singlet">Singlet</option>
              <option value="achromat" selected>Achromat (air spaced)</option>
              <option value="achromat_cemented">Achromat (cemented)</option>
              <option value="stop">STOP (insert)</option>
              <option value="airgap">AIR gap (insert)</option>
            </select>
          </div>

          <div class="field">
            <label>Mode</label>
            <select id="elMode" class="cellSelect">
              <option value="auto" selected>Auto</option>
              <option value="custom">Custom (not implemented)</option>
            </select>
          </div>

          <div class="field">
            <label>F (mm)</label>
            <input id="elF" class="cellInput" type="number" step="0.1" value="50">
          </div>

          <div class="field">
            <label>ap (semi-diam mm)</label>
            <input id="elAp" class="cellInput" type="number" step="0.1" value="18">
          </div>

          <div class="field">
            <label>CT per glass (mm)</label>
            <input id="elCt" class="cellInput" type="number" step="0.01" value="4">
          </div>

          <div class="field">
            <label>Internal air gap (mm)</label>
            <input id="elGap" class="cellInput" type="number" step="0.01" value="0.2">
          </div>

          <div class="field">
            <label>Rear air (mm)</label>
            <input id="elAir" class="cellInput" type="number" step="0.01" value="4">
          </div>

          <div class="field">
            <label>Form</label>
            <select id="elForm" class="cellSelect">
              <option value="symmetric" selected>Symmetric</option>
              <option value="weakmeniscus">Weak meniscus</option>
              <option value="plano">Plano</option>
            </select>
          </div>

          <div class="field">
            <label>Glass 1</label>
            <select id="elGlass1" class="cellSelect"></select>
          </div>

          <div class="field">
            <label>Glass 2</label>
            <select id="elGlass2" class="cellSelect"></select>
          </div>

          <div class="field fieldFull">
            <label>Notes</label>
            <textarea id="elGlassNote" class="glassNote" rows="4" readonly></textarea>
          </div>
        </div>
      </div>

      <div class="modalBottom">
        <button id="elAdd" class="btn btnPrimary">Insert element</button>
      </div>
    </div>
  </div>

  <!-- NEW LENS MODAL -->
  <div id="newLensModal" class="modal hidden" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTop">
        <div>
          <div class="modalTitle">New lens</div>
          <div class="modalSub">Create from template and scale to focal / set T.</div>
        </div>
        <button id="nlClose" class="modalX">Close</button>
      </div>

      <div class="modalScroll">
        <div class="modalGrid">
          <div class="field">
            <label>Template</label>
            <select id="nlTemplate" class="cellSelect">
              <option value="blank">Blank</option>
              <option value="tessar">Tessar-ish</option>
              <option value="omit50v1" selected>OMIT 50 v1 (DG base)</option>
            </select>
          </div>

          <div class="field">
            <label>Name</label>
            <input id="nlName" class="cellInput" type="text" value="New lens">
          </div>

          <div class="field">
            <label>Target focal (mm)</label>
            <input id="nlFocal" class="cellInput" type="number" step="0.1" value="50">
          </div>

          <div class="field">
            <label>Target T</label>
            <input id="nlT" class="cellInput" type="number" step="0.01" value="2.0">
          </div>

          <div class="field fieldFull">
            <label>Stop position</label>
            <select id="nlStopPos" class="cellSelect">
              <option value="keep" selected>Keep as template</option>
              <option value="middle">Force middle</option>
            </select>
          </div>
        </div>
      </div>

      <div class="modalBottom">
        <button id="nlCreate" class="btn btnPrimary">Create</button>
      </div>
    </div>
  </div>

  <div id="toastHost" class="toastHost" aria-live="polite" aria-atomic="true"></div>

  <script src="./script.js"></script>
</body>
</html>
